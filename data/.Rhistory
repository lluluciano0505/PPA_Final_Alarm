pred <- ifelse(p3 >= th, 1L, 0L)
cm   <- table(Actual = dat3$inc_new, Pred = pred)
TN <- cm["0","0"]; FP <- cm["0","1"]
FN <- cm["1","0"]; TP <- cm["1","1"]
tibble(
threshold  = th,
TN  = as.numeric(TN),
FP  = as.numeric(FP),
FN  = as.numeric(FN),
TP  = as.numeric(TP),
accuracy   = (TP + TN) / sum(cm),
sensitivity = TP / (TP + FN),
specificity = TN / (TN + FP),
fpr        = FP / (FP + TN)
)
}
metrics <- bind_rows(
get_metrics(0.9),
get_metrics(0.8),
get_metrics(0.6)
)
metrics
set.seed(123)
# 1. 做一个干净的 data.frame（无 geometry，无 NA）
fire_cv <- fire_firetract |>
st_drop_geometry() |>
mutate(
# 因变量：1 = FalseAlarm, 0 = RealIncident
y = ifelse(inc_new == 1, "FalseAlarm", "RealIncident"),
y = factor(y, levels = c("FalseAlarm", "RealIncident"))  # twoClassSummary 要 factor
) |>
select(
y,
Temperature, Precipitation, Wind_Speed, active_rate,
median_income, ba_rate, black_share, unemployment_rate,
is_weekend, quarter, near_station_200m, dist_cityhall_km
) |>
tidyr::drop_na()   # 关键：把有 NA 的行全部扔掉
set.seed(123)
fire_cv <- fire_firetract |>
sf::st_drop_geometry() |>
dplyr::mutate(
y = ifelse(inc_new == 1, "FalseAlarm", "RealIncident"),
y = factor(y, levels = c("FalseAlarm", "RealIncident"))
) |>
dplyr::select(
y,
Temperature, Precipitation, Wind_Speed, active_rate,
median_income, ba_rate, black_share, unemployment_rate,
is_weekend, quarter, near_station_200m, dist_cityhall_km
) |>
tidyr::drop_na()
train_control <- trainControl(
method = "cv",
number = 5,
classProbs = TRUE,
summaryFunction = twoClassSummary
)
logit_cv_model <- train(
y ~ .,
data      = fire_cv,
method    = "glm",
family    = binomial(link = "logit"),
trControl = train_control,
metric    = "ROC"
)
logit_cv_model
set.seed(123)
fire_cv <- fire_firetract |>
sf::st_drop_geometry() |>
dplyr::mutate(
y = ifelse(inc_new == 1, "FalseAlarm", "RealIncident"),
y = factor(y, levels = c("FalseAlarm", "RealIncident"))
) |>
dplyr::select(
y,
Temperature, Precipitation, Wind_Speed, active_rate,
median_income, ba_rate, black_share, unemployment_rate,
is_weekend, quarter, near_station_200m, dist_cityhall_km
) |>
tidyr::drop_na()
train_control <- trainControl(
method = "cv",
number = 5,
classProbs = TRUE,
summaryFunction = twoClassSummary
)
logit_cv_model <- train(
y ~ .,
data      = fire_cv,
method    = "glm",
family    = binomial(link = "logit"),
trControl = train_control,
metric    = "ROC"
)
logit_cv_model
get_metrics <- function(th) {
pred <- ifelse(p3 >= th, 1L, 0L)
cm   <- table(Actual = dat3$inc_new, Pred = pred)
TN <- cm["0","0"]; FP <- cm["0","1"]
FN <- cm["1","0"]; TP <- cm["1","1"]
tibble(
threshold  = th,
TN  = as.numeric(TN),
FP  = as.numeric(FP),
FN  = as.numeric(FN),
TP  = as.numeric(TP),
accuracy   = (TP + TN) / sum(cm),
sensitivity = TP / (TP + FN),
specificity = TN / (TN + FP),
fpr        = FP / (FP + TN)
)
}
metrics <- bind_rows(
get_metrics(0.85),
get_metrics(0.6)
)
metrics
get_metrics <- function(th) {
pred <- ifelse(p3 >= th, 1L, 0L)
cm   <- table(Actual = dat3$inc_new, Pred = pred)
TN <- cm["0","0"]; FP <- cm["0","1"]
FN <- cm["1","0"]; TP <- cm["1","1"]
tibble(
threshold  = th,
TN  = as.numeric(TN),
FP  = as.numeric(FP),
FN  = as.numeric(FN),
TP  = as.numeric(TP),
accuracy   = (TP + TN) / sum(cm),
sensitivity = TP / (TP + FN),
specificity = TN / (TN + FP),
fpr        = FP / (FP + TN)
)
}
metrics <- bind_rows(
get_metrics(0.88),
get_metrics(0.6)
)
metrics
get_metrics <- function(th) {
pred <- ifelse(p3 >= th, 1L, 0L)
cm   <- table(Actual = dat3$inc_new, Pred = pred)
TN <- cm["0","0"]; FP <- cm["0","1"]
FN <- cm["1","0"]; TP <- cm["1","1"]
tibble(
threshold  = th,
TN  = as.numeric(TN),
FP  = as.numeric(FP),
FN  = as.numeric(FN),
TP  = as.numeric(TP),
accuracy   = (TP + TN) / sum(cm),
sensitivity = TP / (TP + FN),
specificity = TN / (TN + FP),
fpr        = FP / (FP + TN)
)
}
metrics <- bind_rows(
get_metrics(0.9),
get_metrics(0.6)
)
metrics
#| message: false
#| warning: false
# Core packages
library(tidyverse)   # dplyr, ggplot2, readr, tidyr, stringr, etc.
library(sf)
library(tigris)
library(tidycensus)
# Modeling / utilities
library(MASS)
library(caret)
library(broom)
library(patchwork)
library(scales)
library(knitr)
library(riem)
library(dplyr)
library(pROC)
library(tidyr)
library(lubridate)
# tigris options
options(tigris_use_cache = TRUE, tigris_class = "sf", tigris_progress = FALSE)
# set a global theme
theme_set(theme_minimal(base_size = 12))
fire <- st_read("data/stat360/stat360_fire_incidents.shp", quiet = TRUE)
sort(table(fire$incident_2), decreasing = TRUE)[1:20]
fire <- fire |>
filter(!sf::st_is_empty(geometry)) |>
mutate(
incident_code = as.integer(str_extract(incident_1, "^\\d+"))
) |>
filter(incident_code %in% c(1L, 7L)) |>
mutate(
inc_new = if_else(incident_code == 7L, 1L, 0L)
)
fire |>
st_drop_geometry() |>
count(inc_new) |>
mutate(p = n / sum(n)) |>
knitr::kable(digits = 3)
#| message: false
philly_census <- get_acs(
geography = "tract",
variables = c(
total_pop = "B01003_001",
black = "B02001_003",
ba_degree = "B15003_022",
total_edu = "B15003_001",
median_income = "B19013_001",
labor_force = "B23025_003",
unemployed = "B23025_005"
),
year = 2023,
state = "PA",
county = "Philadelphia",
geometry = TRUE
) |>
dplyr::select(GEOID, variable, estimate, geometry) |>
tidyr::pivot_wider(names_from = variable, values_from = estimate) |>
dplyr::mutate(
ba_rate = 100 * ba_degree / total_edu,
unemployment_rate = 100 * unemployed / labor_force,
black_share = 100 * black / total_pop
) |>
st_transform(st_crs(fire))
bldg_foot <- st_read("data/LI_BUILDING_FOOTPRINTS.shp", quiet = TRUE)
cert_sum <- readr::read_csv("data/BUILDING_CERT_SUMMARY.csv", show_col_types = FALSE)
bldg_cert <- bldg_foot |>
mutate(bin = as.character(bin)) |>
inner_join(
cert_sum |>
mutate(structure_id = as.character(structure_id)),
by = c("bin" = "structure_id")
)
bldg_cert |>
st_drop_geometry() |>
summarise(n_bldg = n_distinct(bin))
bldg_cert |>
st_drop_geometry() |>
count(fire_alarm_status, sort = TRUE)
bldg_tract <- bldg_cert |>
st_transform(st_crs(philly_census)) |>
st_join(philly_census["GEOID"])
tract_alarm <- bldg_tract |>
st_drop_geometry() |>
group_by(GEOID) |>
summarise(
n_bldg = n(),
n_active = sum(fire_alarm_status == "Active", na.rm = TRUE),
n_expired = sum(fire_alarm_status == "Expired", na.rm = TRUE),
n_deficient= sum(fire_alarm_status == "Deficient", na.rm = TRUE),
active_rate = n_active / n_bldg
)
philly_census_alarm <- philly_census |>
left_join(tract_alarm, by = "GEOID")
library(riem)
library(dplyr)
library(tidyr)
library(lubridate)
get_phl <- function(start, end) {
riem_measures(
station     = "PHL",
date_start  = start,
date_end    = end,
report_type = c("routine", "specials", "hfmetar")
)
}
w1 <- get_phl("2024-01-01", "2024-03-31")
w2 <- get_phl("2024-04-01", "2024-06-30")
w3 <- get_phl("2024-07-01", "2024-09-30")
w4 <- get_phl("2024-10-01", "2024-12-31")
w5 <- get_phl("2025-01-01", "2025-06-30")
w6 <- get_phl("2025-07-01", "2025-10-06")
weather_data <- bind_rows(w1, w2, w3, w4, w5, w6) |>
arrange(valid) |>
distinct(valid, .keep_all = TRUE)
range(weather_data$valid)
nrow(weather_data)
weather_processed <- weather_data %>%
dplyr::mutate(
interval60    = floor_date(valid, unit = "hour"),
Temperature   = tmpf,
Precipitation = ifelse(is.na(p01i), 0, p01i),
Wind_Speed    = sknt
) %>%
dplyr::select(interval60, Temperature, Precipitation, Wind_Speed) %>%
dplyr::distinct()
weather_complete <- weather_processed %>%
tidyr::complete(
interval60 = seq(min(interval60), max(interval60), by = "hour")
) %>%
tidyr::fill(Temperature, Precipitation, Wind_Speed, .direction = "down") %>%
dplyr::filter(lubridate::hour(interval60) == 12) %>%
dplyr::arrange(interval60) %>%
dplyr::mutate(date = as.Date(interval60)) %>%
dplyr::group_by(date) %>%
dplyr::slice(1) %>%
dplyr::ungroup() %>%
dplyr::select(date, Temperature, Precipitation, Wind_Speed)
weather_complete$Precipitation <- weather_complete$Precipitation + 0.00001
weather_daily <- weather_complete %>%
dplyr::mutate(
dow        = lubridate::wday(date, label = TRUE, week_start = 1),
is_weekend = as.integer(dow %in% c("Sat", "Sun"))   # 0 = weekday, 1 = weekend
)
weather_daily %>%
dplyr::count(is_weekend)
library(readr)
Fire_Dept <- read_csv("data/Fire_Dept.csv")
firesta_sf <- st_as_sf(Fire_Dept , coords = c("lon", "lat"), crs = 4326, remove = FALSE)
firesta_buf <- st_buffer(firesta_sf, dist = 100/0.3)
fire_weather <- fire %>%
dplyr::mutate(
date = as.Date(alarm_date)
) %>%
dplyr::left_join(
weather_daily,
by = "date"
)
fire_weather_station <- fire_weather |>
st_transform(st_crs(firesta_buf))
idx <- st_intersects(fire_weather_station, firesta_buf)
fire_weather_station <- fire_weather_station |>
mutate(
near_station_200m = as.integer(lengths(idx) > 0)
)
philly_census_alarm <- philly_census_alarm |>
st_transform(st_crs(fire_weather_station))
fire_firetract <- fire_weather_station |>
st_join(
philly_census_alarm,
join = st_within,
left = TRUE
)
fire_firetract <- fire_firetract |>
dplyr::mutate(
quarter_num = lubridate::quarter(date), # 1–4
quarter = factor(quarter_num,
levels = 1:4,
labels = c("Q1", "Q2", "Q3", "Q4"))
)
downtown <- tribble(
~name, ~lat,       ~lon,
"Philadelphia City Hall (Downtown)", 39.952583, -75.165222
) %>%
st_as_sf(coords = c("lon","lat"), crs = 4326, remove = FALSE)
n <- nrow(fire_firetract)
fire_firetract <- fire_firetract |>
st_transform(st_crs(downtown)) |>
mutate(
dist_cityhall_m = as.numeric(
st_distance(
geometry,
st_geometry(downtown)[rep(1, n)],
by_element = TRUE
)
),
dist_cityhall_km = dist_cityhall_m / 1000
)
tract_fire_stats <- fire_firetract |>
st_drop_geometry() |>
dplyr::filter(!is.na(GEOID)) |>
dplyr::group_by(GEOID) |>
dplyr::summarise(
n_incidents  = dplyr::n(),
n_false_7   = sum(inc_new == 1, na.rm = TRUE),
false_rate_7 = n_false_7 / n_incidents
)
philly_census_alarm_fire <- philly_census_alarm |>
dplyr::left_join(tract_fire_stats, by = "GEOID")
ggplot(philly_census_alarm_fire) +
geom_sf(aes(fill = false_rate_7), color = NA) +
scale_fill_viridis_c(
option   = "magma",
direction = -1,
na.value = "grey90",
labels   = scales::percent_format(accuracy = 1),
name     = "False alarm rate\n(inc_67 share)"
) +
labs(
title    = "False Alarm Rate of Fire Incidents by Census Tract",
subtitle = "Share of incidents with primary code 7",
caption  = "Tracts with no incidents shown in grey."
) +
theme_void() +
theme(
legend.position = "right",
plot.title      = element_text(face = "bold")
)
quarter_stats <- fire_firetract |>
st_drop_geometry() |>
dplyr::filter(!is.na(quarter)) |>
dplyr::group_by(quarter) |>
dplyr::summarise(
n_incidents  = dplyr::n(),
n_false_7   = sum(inc_new == 1, na.rm = TRUE),
false_rate_7 = n_false_7 / n_incidents
)
ggplot(quarter_stats, aes(x = quarter, y = false_rate_7)) +
geom_col(fill = "blue3") +
geom_text(aes(label = scales::percent(false_rate_7, accuracy = 1)),
vjust = -0.3, size = 3) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
labs(
title = "City-wide False Alarm Rate by Quarter",
x     = "Quarter",
y     = "False alarm rate (inc_67 share of incidents)"
) +
theme_minimal()
logit_model1 <- glm(
inc_new ~ Temperature + Precipitation + Wind_Speed + active_rate,
data   = fire_firetract,
family = binomial(link = "logit")
)
summary(logit_model1)
logit_model2 <- glm(
inc_new ~ Temperature + Precipitation + Wind_Speed + active_rate +
median_income + ba_rate + black_share + unemployment_rate,
data   = fire_firetract,
family = binomial(link = "logit")
)
summary(logit_model2)
logit_model3 <- glm(
inc_new ~ Temperature + Precipitation + Wind_Speed + active_rate +
median_income + ba_rate + black_share + unemployment_rate +
is_weekend + quarter + near_station_200m + dist_cityhall_km,
data   = fire_firetract,
family = binomial(link = "logit")
)
summary(logit_model3)
dat1 <- model.frame(logit_model1)
p1   <- predict(logit_model1, type = "response")
roc1 <- roc(dat1$inc_new, p1)
auc1 <- auc(roc1)
dat2 <- model.frame(logit_model2)
p2   <- predict(logit_model2, type = "response")
roc2 <- roc(dat2$inc_new, p2)
auc2 <- auc(roc2)
dat3 <- model.frame(logit_model3)
p3   <- predict(logit_model3, type = "response")
roc3 <- roc(dat3$inc_new, p3)
auc3 <- auc(roc3)
data.frame(
model = c("logit_model1", "logit_model2", "logit_model3"),
AUC   = c(auc1, auc2, auc3)
)
plot(roc1, col = "blue", lwd = 2, main = "ROC Curves for Logit Models")
plot(roc2, col = "red", lwd = 2, add = TRUE)
plot(roc3, col = "purple", lwd = 2, add = TRUE)
legend("bottomright",
legend = c("Model 1", "Model 2", "Model 3"),
col    = c("blue", "red", "purple"),
lwd    = 2)
odds_ratios <- exp(coef(logit_model3))
odds_ratios_df <- data.frame(
Variable    = names(odds_ratios),
Odds_Ratio = odds_ratios
)
odds_ratios_df %>%
knitr::kable(digits = 3, caption = "Odds Ratios for Logit Model 3")
get_metrics <- function(th) {
pred <- ifelse(p3 >= th, 1L, 0L)
cm   <- table(Actual = dat3$inc_new, Pred = pred)
TN <- cm["0","0"]; FP <- cm["0","1"]
FN <- cm["1","0"]; TP <- cm["1","1"]
tibble(
threshold  = th,
TN  = as.numeric(TN),
FP  = as.numeric(FP),
FN  = as.numeric(FN),
TP  = as.numeric(TP),
accuracy   = (TP + TN) / sum(cm),
sensitivity = TP / (TP + FN),
specificity = TN / (TN + FP),
fpr        = FP / (FP + TN)
)
}
metrics <- bind_rows(
get_metrics(0.9),
get_metrics(0.6)
)
metrics
set.seed(123)
fire_cv <- fire_firetract |>
sf::st_drop_geometry() |>
dplyr::mutate(
y = ifelse(inc_new == 1, "FalseAlarm", "RealIncident"),
y = factor(y, levels = c("FalseAlarm", "RealIncident"))
) |>
dplyr::select(
y,
Temperature, Precipitation, Wind_Speed, active_rate,
median_income, ba_rate, black_share, unemployment_rate,
is_weekend, quarter, near_station_200m, dist_cityhall_km
) |>
tidyr::drop_na()
train_control <- trainControl(
method = "cv",
number = 5,
classProbs = TRUE,
summaryFunction = twoClassSummary
)
logit_cv_model <- train(
y ~ .,
data      = fire_cv,
method    = "glm",
family    = binomial(link = "logit"),
trControl = train_control,
metric    = "ROC"
)
logit_cv_model
